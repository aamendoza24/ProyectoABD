{% extends "layout.html" %}

{% block title %}Administración de Empleados{% endblock %}

{% block style %}
<link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.2.9/css/responsive.bootstrap5.min.css">

<style>
    .status-badge {
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
    }
    
    .status-active {
        background-color: rgba(28, 200, 138, 0.1);
        color: #1cc88a;
        border: 1px solid rgba(28, 200, 138, 0.2);
    }
    
    .status-inactive {
        background-color: rgba(231, 74, 59, 0.1);
        color: #e74a3b;
        border: 1px solid rgba(231, 74, 59, 0.2);
    }
    
    .status-locked {
        background-color: rgba(246, 194, 62, 0.1);
        color: #f6c23e;
        border: 1px solid rgba(246, 194, 62, 0.2);
    }
    
    .action-btn {
        margin: 0 2px;
        padding: 4px 8px;
        font-size: 0.8rem;
    }
    
    .modal-header {
        background-color: #4e73df;
        color: white;
    }
    
    .required-field::after {
        content: " *";
        color: red;
    }
    
    .filter-section {
        background-color: #f8f9fc;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
        border: 1px solid #e3e6f0;
    }
    
    .card-header {
        background-color: #f8f9fc;
        border-bottom: 1px solid #e3e6f0;
    }
    
    .card {
        box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
        border: none;
        border-radius: 0.35rem;
    }
    
    .btn-icon {
        padding: 0.375rem 0.75rem;
    }
    
    .btn-icon i {
        margin-right: 5px;
    }
    
    .activity-log {
        max-height: 300px;
        overflow-y: auto;
    }
    
    .activity-item {
        padding: 10px;
        border-bottom: 1px solid #e3e6f0;
    }
    
    .activity-item:last-child {
        border-bottom: none;
    }
    
    .activity-time {
        font-size: 0.8rem;
        color: #858796;
    }
    
    .activity-type {
        font-weight: 600;
    }
    
    .activity-description {
        margin-top: 5px;
    }
</style>
{% endblock %}

{% block main %}
<div class="container-fluid">
    <div class="page-header">
        <h4 class="page-title">Administración de Empleados</h4>
        <ul class="breadcrumbs">
            <li class="nav-home">
                <a href="{{ url_for('dashboard.index') }}">
                    <i class="fas fa-home"></i>
                </a>
            </li>
            <li class="separator">
                <i class="fas fa-angle-right"></i>
            </li>
            <li class="nav-item">
                <a href="#">Administración</a>
            </li>
            <li class="separator">
                <i class="fas fa-angle-right"></i>
            </li>
            <li class="nav-item">
                <a href="#">Empleados</a>
            </li>
        </ul>
    </div>
    
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}
    
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="card-title">Listado de Empleados</h4>
                        <button class="btn btn-primary " data-bs-toggle="modal" data-bs-target="#addEmployeeModal">
                            <i class="fas fa-plus"></i> Nuevo Empleado
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="filter-section mb-4">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="filterStatus">Estado</label>
                                    <select class="form-control" id="filterStatus">
                                        <option value="">Todos</option>
                                        <option value="activo">Activos</option>
                                        <option value="inactive">Inactivos</option>
                                        <option value="locked">Bloqueados</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="filterRole">Rol</label>
                                    <select class="form-control" id="filterRole">
                                        <option value="">Todos</option>
                                        <option value="admin">Administrador</option>
                                        <option value="gerente">Gerente</option>
                                        <option value="vendedor">Vendedor</option>
                                        <option value="almacen">Almacén</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="filterCargo">Cargo</label>
                                    <select class="form-control" id="filterCargo">
                                        <option value="">Todos</option>
                                        {% for cargo in cargos %}
                                            <option value="{{ cargo.IDCargo }}">{{ cargo.Nombre }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="filterSucursal">Sucursal</label>
                                    <select class="form-control" id="filterSucursal">
                                        <option value="">Todas</option>
                                        {% for sucursal in sucursales %}
                                            <option value="{{ sucursal.IDSucursal }}">{{ sucursal.Nombre }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table id="employeesTable" class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Nombre</th>
                                    <th>Usuario</th>
                                    <th>Email</th>
                                    <th>Rol</th>
                                    <th>Estado</th>
                                    <th>Último Acceso</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for employee in employees %}
                                <tr>
                                    <td>{{ employee.IDEmpleado }}</td>
                                    <td>{{ employee.NombreCompleto }}</td>
                                    <td>{{ employee.user }}</td>
                                    <td>{{ employee.email }}</td>
                                    <td>{{ employee.role|capitalize }}</td>
                                    <td>
                                        {% if employee.account_locked %}
                                            <span class="status-badge status-locked">Bloqueado</span>
                                        {% elif employee.is_active %}
                                            <span class="status-badge status-active">Activo</span>
                                        {% else %}
                                            <span class="status-badge status-inactive">Inactivo</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ employee.last_login|default('Nunca', true) }}</td>
                                    <td>
                                        <button class="btn btn-info btn-sm action-btn" onclick="viewEmployee({{ employee.IDEmpleado }})" title="Ver detalles">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-primary btn-sm action-btn" onclick="editEmployee({{ employee.IDEmpleado }})" title="Editar">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        {% if employee.is_active %}
                                            <button class="btn btn-warning btn-sm action-btn" onclick="toggleStatus({{ employee.IDEmpleado }}, 'disable')" title="Deshabilitar">
                                                <i class="fas fa-user-slash"></i>
                                            </button>
                                        {% else %}
                                            <button class="btn btn-success btn-sm action-btn" onclick="toggleStatus({{ employee.IDEmpleado }}, 'enable')" title="Habilitar">
                                                <i class="fas fa-user-check"></i>
                                            </button>
                                        {% endif %}
                                        {% if employee.account_locked %}
                                            <button class="btn btn-success btn-sm action-btn" onclick="toggleLock({{ employee.IDEmpleado }}, 'unlock')" title="Desbloquear">
                                                <i class="fas fa-unlock"></i>
                                            </button>
                                        {% else %}
                                            <button class="btn btn-warning btn-sm action-btn" onclick="toggleLock({{ employee.IDEmpleado }}, 'lock')" title="Bloquear">
                                                <i class="fas fa-lock"></i>
                                            </button>
                                        {% endif %}
                                        <button class="btn btn-danger btn-sm action-btn" onclick="confirmDelete({{ employee.IDEmpleado }})" title="Eliminar">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Añadir Empleado -->
<div class="modal fade" id="addEmployeeModal" tabindex="-1" aria-labelledby="addEmployeeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addEmployeeModalLabel">Nuevo Empleado</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addEmployeeForm" action="{{ url_for('admin.add_employee') }}" method="POST">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="nombreCompleto" class="required-field">Nombre Completo</label>
                                <input type="text" class="form-control" id="nombreCompleto" name="nombreCompleto" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="cargo" class="required-field">Cargo</label>
                                <select class="form-control" id="cargo" name="cargo" required>
                                    <option value="">Seleccionar Cargo</option>
                                    {% for cargo in cargos %}
                                        <option value="{{ cargo.IDCargo }}">{{ cargo.Nombre }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="username" class="required-field">Nombre de Usuario</label>
                                <input type="text" class="form-control" id="username" name="username" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="email" class="required-field">Correo Electrónico</label>
                                <input type="email" class="form-control" id="email" name="email" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="password" class="required-field">Contraseña</label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="password" name="password" required>
                                    <button class="btn btn-outline-secondary toggle-password" type="button">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="confirmPassword" class="required-field">Confirmar Contraseña</label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="confirmPassword" name="confirmPassword" required>
                                    <button class="btn btn-outline-secondary toggle-password" type="button">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="role" class="required-field">Rol</label>
                                <select class="form-control" id="role" name="role" required>
                                    <option value="">Seleccionar Rol</option>
                                    <option value="admin">Administrador</option>
                                    <option value="gerente">Gerente</option>
                                    <option value="vendedor">Vendedor</option>
                                    <option value="almacen">Almacén</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="sucursal" class="required-field">Sucursal</label>
                                <select class="form-control" id="sucursal" name="sucursal" required>
                                    <option value="">Seleccionar Sucursal</option>
                                    {% for sucursal in sucursales %}
                                        <option value="{{ sucursal.IDSucursal }}">{{ sucursal.Nombre }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="form-group mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="isActive" name="isActive" checked>
                            <label class="form-check-label" for="isActive">
                                Cuenta Activa
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="submitAddEmployeeForm()">Guardar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Editar Empleado -->
<div class="modal fade" id="editEmployeeModal" tabindex="-1" aria-labelledby="editEmployeeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editEmployeeModalLabel">Editar Empleado</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editEmployeeForm" action="{{ url_for('admin.edit_employee') }}" method="POST">
                    <input type="hidden" id="editEmployeeId" name="employeeId">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="editNombreCompleto" class="required-field">Nombre Completo</label>
                                <input type="text" class="form-control" id="editNombreCompleto" name="nombreCompleto" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="editCargo" class="required-field">Cargo</label>
                                <select class="form-control" id="editCargo" name="cargo" required>
                                    <option value="">Seleccionar Cargo</option>
                                    {% for cargo in cargos %}
                                        <option value="{{ cargo.IDCargo }}">{{ cargo.Nombre }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="editUsername" class="required-field">Nombre de Usuario</label>
                                <input type="text" class="form-control" id="editUsername" name="username" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="editEmail" class="required-field">Correo Electrónico</label>
                                <input type="email" class="form-control" id="editEmail" name="email" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="editPassword">Nueva Contraseña (dejar en blanco para mantener la actual)</label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="editPassword" name="password">
                                    <button class="btn btn-outline-secondary toggle-password" type="button">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="editConfirmPassword">Confirmar Nueva Contraseña</label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="editConfirmPassword" name="confirmPassword">
                                    <button class="btn btn-outline-secondary toggle-password" type="button">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="editRole" class="required-field">Rol</label>
                                <select class="form-control" id="editRole" name="role" required>
                                    <option value="">Seleccionar Rol</option>
                                    <option value="admin">Administrador</option>
                                    <option value="gerente">Gerente</option>
                                    <option value="vendedor">Vendedor</option>
                                    <option value="almacen">Almacén</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="editSucursal" class="required-field">Sucursal</label>
                                <select class="form-control" id="editSucursal" name="sucursal" required>
                                    <option value="">Seleccionar Sucursal</option>
                                    {% for sucursal in sucursales %}
                                        <option value="{{ sucursal.IDSucursal }}">{{ sucursal.Nombre }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="form-group mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="editIsActive" name="isActive">
                            <label class="form-check-label" for="editIsActive">
                                Cuenta Activa
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="submitEditEmployeeForm()">Guardar Cambios</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Ver Detalles del Empleado -->
<div class="modal fade" id="viewEmployeeModal" tabindex="-1" aria-labelledby="viewEmployeeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewEmployeeModalLabel">Detalles del Empleado</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="font-weight-bold">Información Personal</h6>
                        <table class="table table-bordered">
                            <tr>
                                <th>ID Empleado</th>
                                <td id="viewEmployeeId"></td>
                            </tr>
                            <tr>
                                <th>Nombre Completo</th>
                                <td id="viewNombreCompleto"></td>
                            </tr>
                            <tr>
                                <th>Cargo</th>
                                <td id="viewCargo"></td>
                            </tr>
                            <tr>
                                <th>Sucursal</th>
                                <td id="viewSucursal"></td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6 class="font-weight-bold">Información de Cuenta</h6>
                        <table class="table table-bordered">
                            <tr>
                                <th>Usuario</th>
                                <td id="viewUsername"></td>
                            </tr>
                            <tr>
                                <th>Email</th>
                                <td id="viewEmail"></td>
                            </tr>
                            <tr>
                                <th>Rol</th>
                                <td id="viewRole"></td>
                            </tr>
                            <tr>
                                <th>Estado</th>
                                <td id="viewStatus"></td>
                            </tr>
                        </table>
                    </div>
                </div>
                <div class="row mt-4">
                    <div class="col-md-12">
                        <h6 class="font-weight-bold">Actividad Reciente</h6>
                        <div class="activity-log" id="activityLog">
                            <!-- La actividad se cargará dinámicamente -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary" onclick="editEmployee(document.getElementById('viewEmployeeId').textContent)">Editar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirmación para Eliminar -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteConfirmModalLabel">Confirmar Eliminación</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>¿Estás seguro de que deseas eliminar a este empleado? Esta acción no se puede deshacer.</p>
                <p><strong>Nota:</strong> Esta acción eliminará la cuenta de usuario asociada y todos los datos relacionados.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <form id="deleteEmployeeForm" action="{{ url_for('admin.delete_employee') }}" method="POST">
                    <input type="hidden" id="deleteEmployeeId" name="employeeId">
                    <button type="submit" class="btn btn-danger">Eliminar</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- DataTables JS -->
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.2.9/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.2.9/js/responsive.bootstrap5.min.js"></script>

<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    $(document).ready(function() {
        // Inicializar DataTable
        var table = $('#employeesTable').DataTable({
            responsive: true,
            language: {
                url: '//cdn.datatables.net/plug-ins/1.11.5/i18n/es-ES.json'
            },
            columnDefs: [
                { orderable: false, targets: -1 } // Deshabilitar ordenamiento en la columna de acciones
            ]
        });

        
        // Filtros de tabla
        $('#filterStatus, #filterRole, #filterCargo, #filterSucursal').on('change', function() {
            filterTable();
        });
        
        function filterTable() {
            var statusFilter = $('#filterStatus').val();
            var roleFilter = $('#filterRole').val();
            var cargoFilter = $('#filterCargo').val();
            var sucursalFilter = $('#filterSucursal').val();
            
            // Limpiar filtros anteriores
            table.search('').columns().search('').draw();
            
            // Aplicar filtros
            if (statusFilter) {
                table.column(6).search(getStatusText(statusFilter)).draw();
            }
            
            if (roleFilter) {
                table.column(4).search(roleFilter.charAt(0).toUpperCase() + roleFilter.slice(1)).draw();
            }
            
            //if (cargoFilter) {
              //  table.column(4).search($('#filterCargo option:selected').text()).draw();
            //}
            
            // Para el filtro de sucursal, necesitaríamos añadir la columna de sucursal a la tabla
        }
        
        function getStatusText(status) {
            switch(status) {
                case 'active': return 'Activo';
                case 'inactive': return 'Inactivo';
                case 'locked': return 'Bloqueado';
                default: return '';
            }
        }
        
        // Toggle password visibility
        $('.toggle-password').on('click', function() {
            var input = $(this).closest('.input-group').find('input');
            var type = input.attr('type') === 'password' ? 'text' : 'password';
            input.attr('type', type);
            $(this).find('i').toggleClass('fa-eye fa-eye-slash');
        });

        $('.toggle-sidebar, .sidenav-toggler').on('click', function() {
            setTimeout(function() {
                table.columns.adjust().responsive.recalc();
            }, 300);

            $(window).trigger('resize');
            table.columns.adjust().responsive.recalc();
        });
    });
    
    // Funciones para manejar empleados
    function viewEmployee(employeeId) {
        // Hacer una solicitud AJAX para obtener los detalles del empleado
        $.ajax({
            url: "{{ url_for('admin.get_employee_details') }}",
            type: "GET",
            data: { employeeId: employeeId },
            success: function(response) {
                if (response.success) {
                    var employee = response.employee;
                    
                    // Llenar los campos del modal
                    $('#viewEmployeeId').text(employee.IDEmpleado);
                    $('#viewNombreCompleto').text(employee.NombreCompleto);
                    $('#viewCargo').text(employee.cargo_nombre);
                    $('#viewSucursal').text(employee.sucursal_nombre);
                    $('#viewUsername').text(employee.user);
                    $('#viewEmail').text(employee.email);
                    $('#viewRole').text(employee.role.charAt(0).toUpperCase() + employee.role.slice(1));
                    
                    // Establecer el estado
                    var statusText = '';
                    var statusClass = '';
                    if (employee.account_locked) {
                        statusText = 'Bloqueado';
                        statusClass = 'status-locked';
                    } else if (employee.is_active) {
                        statusText = 'Activo';
                        statusClass = 'status-active';
                    } else {
                        statusText = 'Inactivo';
                        statusClass = 'status-inactive';
                    }
                    $('#viewStatus').html('<span class="status-badge ' + statusClass + '">' + statusText + '</span>');
                    
                    // Cargar actividad reciente
                    var activityLog = $('#activityLog');
                    activityLog.empty();
                    
                    if (response.activity && response.activity.length > 0) {
                        response.activity.forEach(function(activity) {
                            var activityItem = $('<div class="activity-item"></div>');
                            activityItem.append('<div class="activity-time">' + activity.timestamp + '</div>');
                            activityItem.append('<div class="activity-type">' + activity.activity_type + '</div>');
                            activityItem.append('<div class="activity-description">' + activity.description + '</div>');
                            activityLog.append(activityItem);
                        });
                    } else {
                        activityLog.append('<div class="p-3 text-center">No hay actividad reciente</div>');
                    }
                    
                    // Mostrar el modal
                    $('#viewEmployeeModal').modal('show');
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: response.message || 'No se pudo cargar la información del empleado'
                    });
                }
            },
            error: function() {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Ocurrió un error al cargar la información del empleado'
                });
            }
        });
    }
    
    function editEmployee(employeeId) {
        // Cerrar el modal de detalles si está abierto
        $('#viewEmployeeModal').modal('hide');
        
        // Hacer una solicitud AJAX para obtener los detalles del empleado
        $.ajax({
            url: "{{ url_for('admin.get_employee_details') }}",
            type: "GET",
            data: { employeeId: employeeId },
            success: function(response) {
                if (response.success) {
                    var employee = response.employee;
                    
                    // Llenar los campos del formulario
                    $('#editEmployeeId').val(employee.IDEmpleado);
                    $('#editNombreCompleto').val(employee.NombreCompleto);
                    $('#editCargo').val(employee.IDCargo);
                    $('#editUsername').val(employee.user);
                    $('#editEmail').val(employee.email);
                    $('#editRole').val(employee.role);
                    $('#editSucursal').val(employee.IDSucursal);
                    $('#editIsActive').prop('checked', employee.is_active);
                    
                    // Limpiar campos de contraseña
                    $('#editPassword').val('');
                    $('#editConfirmPassword').val('');
                    
                    // Mostrar el modal
                    $('#editEmployeeModal').modal('show');
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: response.message || 'No se pudo cargar la información del empleado'
                    });
                }
            },
            error: function() {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Ocurrió un error al cargar la información del empleado'
                });
            }
        });
    }
    
    function toggleStatus(employeeId, action) {
        var message = action === 'enable' ? 'habilitar' : 'deshabilitar';
        
        Swal.fire({
            title: '¿Estás seguro?',
            text: '¿Deseas ' + message + ' a este empleado?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Sí, ' + message,
            cancelButtonText: 'Cancelar'
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    url: "{{ url_for('admin.toggle_employee_status') }}",
                    type: "POST",
                    data: { 
                        employeeId: employeeId,
                        action: action
                    },
                    success: function(response) {
                        if (response.success) {
                            Swal.fire({
                                icon: 'success',
                                title: 'Éxito',
                                text: response.message,
                                timer: 1500,
                                showConfirmButton: false
                            }).then(() => {
                                location.reload();
                            });
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: response.message
                            });
                        }
                    },
                    error: function() {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Ocurrió un error al procesar la solicitud'
                        });
                    }
                });
            }
        });
    }
    
    function toggleLock(employeeId, action) {
        var message = action === 'unlock' ? 'desbloquear' : 'bloquear';
        
        Swal.fire({
            title: '¿Estás seguro?',
            text: '¿Deseas ' + message + ' a este empleado?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Sí, ' + message,
            cancelButtonText: 'Cancelar'
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    url: "{{ url_for('admin.toggle_employee_lock') }}",
                    type: "POST",
                    data: { 
                        employeeId: employeeId,
                        action: action
                    },
                    success: function(response) {
                        if (response.success) {
                            Swal.fire({
                                icon: 'success',
                                title: 'Éxito',
                                text: response.message,
                                timer: 1500,
                                showConfirmButton: false
                            }).then(() => {
                                location.reload();
                            });
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: response.message
                            });
                        }
                    },
                    error: function() {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Ocurrió un error al procesar la solicitud'
                        });
                    }
                });
            }
        });
    }
    
    function confirmDelete(employeeId) {
        $('#deleteEmployeeId').val(employeeId);
        $('#deleteConfirmModal').modal('show');
    }
    
    function submitAddEmployeeForm() {
        var form = $('#addEmployeeForm');
        
        // Validar contraseñas
        var password = $('#password').val();
        var confirmPassword = $('#confirmPassword').val();
        
        if (password !== confirmPassword) {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Las contraseñas no coinciden'
            });
            return;
        }
        
        // Validar fortaleza de contraseña
        if (!validatePassword(password)) {
            return;
        }
        
        // Enviar formulario
        form.submit();
    }
    
    function submitEditEmployeeForm() {
        var form = $('#editEmployeeForm');
        
        // Validar contraseñas si se están cambiando
        var password = $('#editPassword').val();
        var confirmPassword = $('#editConfirmPassword').val();
        
        if (password || confirmPassword) {
            if (password !== confirmPassword) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Las contraseñas no coinciden'
                });
                return;
            }
            
            // Validar fortaleza de contraseña
            if (password && !validatePassword(password)) {
                return;
            }
        }
        
        // Enviar formulario
        form.submit();
    }
    
    function validatePassword(password) {
        if (password.length < 8) {
            Swal.fire({
                icon: 'error',
                title: 'Contraseña débil',
                text: 'La contraseña debe tener al menos 8 caracteres'
            });
            return false;
        }
        
        var hasLowerCase = /[a-z]/.test(password);
        var hasUpperCase = /[A-Z]/.test(password);
        var hasNumber = /\d/.test(password);
        var hasSpecialChar = /[^a-zA-Z\d]/.test(password);
        
        if (!(hasLowerCase && hasUpperCase && hasNumber && hasSpecialChar)) {
            Swal.fire({
                icon: 'error',
                title: 'Contraseña débil',
                text: 'La contraseña debe contener al menos una letra minúscula, una letra mayúscula, un número y un carácter especial'
            });
            return false;
        }
        
        return true;
    }
</script>
{% endblock %}