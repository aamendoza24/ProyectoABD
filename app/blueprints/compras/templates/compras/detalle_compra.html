{% extends "layout.html" %}
{% block title %}Detalle de Compra #{{ compra.IDCompra }}{% endblock %}
{% block main %}
<div class="page-header">
    <h4 class="page-title">Detalle de Compra #{{ compra.IDCompra }}</h4>
    <ul class="breadcrumbs">
        <li class="nav-home">
            <a href="{{ url_for('dashboard.index') }}">
                <i class="fas fa-home"></i>
            </a>
        </li>
        <li class="separator">
            <i class="fas fa-angle-right"></i>
        </li>
        <li class="nav-item">
            <a href="{{ url_for('compras.index') }}">Compras</a>
        </li>
        <li class="separator">
            <i class="fas fa-angle-right"></i>
        </li>
        <li class="nav-item">
            <a href="#">Detalle #{{ compra.IDCompra }}</a>
        </li>
    </ul>
    <div class="btn-group">
        <a href="{{ url_for('compras.index') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Volver a Compras
        </a>
        <button class="btn btn-primary" onclick="window.print()">
            <i class="fas fa-print"></i> Imprimir
        </button>
    </div>
</div>

<!-- Mensajes flash -->
{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
{% for category, message in messages %}
<div class="alert alert-{{ category }} alert-dismissible fade show">
    {{ message }}
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% endfor %}
{% endif %}
{% endwith %}

<div class="row">
    <!-- Información general de la compra -->
    <div class="col-md-4">
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Información de la Compra</h5>
            </div>
            <div class="card-body">
                <table class="table table-borderless">
                    <tr>
                        <th>Número:</th>
                        <td>{{ compra.IDCompra }}</td>
                    </tr>
                    <tr>
                        <th>Fecha:</th>
                        <td>{{ compra.Fecha }}</td>
                    </tr>
                    <tr>
                        <th>Total:</th>
                        <td>${{ "%.2f"|format(compra.Total) }}</td>
                    </tr>
                </table>
            </div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">Proveedor</h5>
            </div>
            <div class="card-body">
                <table class="table table-borderless">
                    <tr>
                        <th>Nombre:</th>
                        <td>{{ compra.Proveedor }}</td>
                    </tr>
                    <tr>
                        <th>Teléfono:</th>
                        <td>{{ compra.ProveedorTelefono }}</td>
                    </tr>
                    <tr>
                        <th>Email:</th>
                        <td>{{ compra.ProveedorEmail }}</td>
                    </tr>
                </table>
            </div>
        </div>

        <div class="card shadow-sm">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">Sucursal</h5>
            </div>
            <div class="card-body">
                <p class="mb-0">{{ compra.Sucursal }}</p>
            </div>
        </div>
    </div>

    <!-- Detalle de productos -->
    <div class="col-md-8">
        <div class="card shadow-sm">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">Productos Comprados</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="tabla-productos">
                        <thead class="table-light">
                            <tr>
                                <th>Producto</th>
                                <th>Categoría</th>
                                <th>Precio</th>
                                <th>Cantidad</th>
                                <th>Subtotal</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for detalle in detalles %}
                            <tr>
                                <td>{{ detalle.Producto }}</td>
                                <td>
                                    <span class="badge bg-secondary">{{ detalle.Categoria }}</span>
                                </td>
                                <td>${{ "%.2f"|format(detalle.PrecioUnitario) }}</td>
                                <td>{{ detalle.Cantidad }}</td>
                                <td>${{ "%.2f"|format(detalle.Subtotal) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot class="table-light">
                            <tr>
                                <th colspan="4" class="text-end">Total:</th>
                                <th>${{ "%.2f"|format(compra.Total) }}</th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

        <!-- Gráfico de distribución de la compra -->
        <div class="card shadow-sm mt-4">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0">Distribución de la Compra</h5>
            </div>
            <div class="card-body">
                <canvas id="graficoDistribucion" height="250"></canvas>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        // Inicializar DataTables
        if ($.fn.dataTable) {
            $('#tabla-productos').DataTable({
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.10.25/i18n/Spanish.json'
                },
                responsive: true
            });
        }
        
        // Datos para el gráfico
        const productos = [{% for detalle in detalles %}"{{ detalle.Producto }}",{% endfor %}];
        const subtotales = [{% for detalle in detalles %}{{ detalle.Subtotal }},{% endfor %}];
        
        // Generar colores aleatorios
        const colores = subtotales.map(() => {
            const r = Math.floor(Math.random() * 200);
            const g = Math.floor(Math.random() * 200);
            const b = Math.floor(Math.random() * 200);
            return `rgba(${r}, ${g}, ${b}, 0.7)`;
        });
        
        // Crear el gráfico
        const ctx = document.getElementById('graficoDistribucion').getContext('2d');
        new Chart(ctx, {
            type: 'pie',
            data: {
                labels: productos,
                datasets: [{
                    data: subtotales,
                    backgroundColor: colores,
                    borderColor: 'rgba(255, 255, 255, 0.7)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'right',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = Math.round((value / total) * 100);
                                return `${label}: $${value.toFixed(2)} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    });
</script>

<style>
    @media print {
        .btn, .alert, .no-print {
            display: none !important;
        }
        
        .card {
            border: 1px solid #ddd !important;
            box-shadow: none !important;
        }
        
        .card-header {
            background-color: #f8f9fa !important;
            color: #000 !important;
            border-bottom: 1px solid #ddd !important;
        }
        
        body {
            font-size: 12pt;
        }
    }
</style>
{% endblock %}